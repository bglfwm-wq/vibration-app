<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibration App v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn:active { transform: scale(0.97); }
        .btn-disabled { cursor: not-allowed; opacity: 0.5; }
        .log-entry {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800">Aplicación de Vibración</h1>
            <p class="text-gray-500 text-sm mt-1">Versión con solicitud automática de permiso.</p>
        </div>

        <!-- Diagnostic Box -->
        <div id="diagnostic-box" class="mb-6">
            <!-- Content generated by JavaScript -->
        </div>

        <!-- Vibration Button -->
        <div class="mb-6">
            <button id="vibrate-notification" class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg text-lg btn-disabled" disabled>
                Vibrar Ahora
            </button>
        </div>
        
        <!-- Event Log -->
        <div>
            <h3 class="text-sm font-semibold text-gray-600 mb-2 border-b pb-1">Registro de Eventos:</h3>
            <div id="event-log" class="text-xs text-gray-500 space-y-1 h-24 overflow-y-auto bg-gray-50 p-2 rounded">
                <!-- Log messages will appear here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const notificationVibrateBtn = document.getElementById('vibrate-notification');
            const diagnosticBox = document.getElementById('diagnostic-box');
            const eventLog = document.getElementById('event-log');

            function log(message) {
                const time = new Date().toLocaleTimeString();
                const newEntry = document.createElement('p');
                newEntry.className = 'log-entry';
                newEntry.innerHTML = `<span class="font-mono text-gray-400">${time}:</span> ${message}`;
                eventLog.prepend(newEntry);
            }

            function runDiagnostics() {
                let html = '';
                log('Ejecutando diagnóstico de permisos...');

                if (!window.isSecureContext) {
                    html = `<div class="bg-red-100 text-red-700 p-3 rounded"><p><b>Error:</b> Se requiere un sitio HTTPS.</p></div>`;
                    log('Diagnóstico fallido: Contexto no seguro.');
                    diagnosticBox.innerHTML = html;
                    return;
                }

                if (!('Notification' in window)) {
                    html = `<div class="bg-red-100 text-red-700 p-3 rounded"><p><b>Error:</b> El navegador no soporta Notificaciones.</p></div>`;
                    log('Diagnóstico fallido: API de Notificación no encontrada.');
                } else {
                    const permission = Notification.permission;
                    switch(permission) {
                        case 'granted':
                            html = `<div class="bg-green-100 text-green-800 p-3 rounded"><p><b>Estado:</b> ✅ Permiso concedido. ¡Listo para vibrar!</p></div>`;
                            notificationVibrateBtn.disabled = false;
                            notificationVibrateBtn.classList.remove('btn-disabled');
                            log('Diagnóstico OK: Permiso ya concedido.');
                            break;
                        case 'denied':
                            html = `<div class="bg-red-100 text-red-700 p-3 rounded"><p><b>Estado:</b> ❌ Permiso denegado. Debes cambiarlo en los ajustes del sitio en Chrome.</p></div>`;
                            log('Diagnóstico fallido: Permiso denegado por el usuario.');
                            break;
                        case 'default':
                            html = `<div class="bg-yellow-100 text-yellow-800 p-3 rounded"><p><b>Estado:</b> ⏳ Solicitando permiso de notificación...</p></div>`;
                            log('Diagnóstico: Permiso no definido. Solicitando ahora...');
                            // --- CAMBIO CLAVE: Se solicita el permiso automáticamente ---
                            requestNotificationPermission();
                            break;
                    }
                }
                diagnosticBox.innerHTML = html;
            }

            function requestNotificationPermission() {
                Notification.requestPermission().then(permission => {
                    log(`El usuario respondió a la solicitud. Nuevo estado: ${permission}`);
                    runDiagnostics(); // Re-ejecutar diagnóstico para actualizar la UI
                });
            }
            
            notificationVibrateBtn.addEventListener('click', () => {
                if (Notification.permission === 'granted') {
                    log('Botón presionado. Enviando comando de vibración...');
                    const options = {
                        vibrate: [200, 100, 300], // Patrón: vibra, pausa, vibra más largo
                        silent: true,
                        tag: 'vibration-test'
                    };
                    try {
                        const notification = new Notification('Comando de Vibración', options);
                        setTimeout(() => notification.close(), 1000);
                        log('Notificación con vibración creada exitosamente.');
                    } catch (error) {
                        log(`Error al crear la notificación: ${error.message}`);
                    }
                } else {
                    log('Botón presionado pero no hay permiso para vibrar.');
                }
            });

            // Iniciar todo al cargar la página
            runDiagnostics();
        });
    </script>
</body>
</html>


