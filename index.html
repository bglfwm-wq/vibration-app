<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo de Notificaci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn:active { transform: scale(0.97); }
        .btn-disabled { cursor: not-allowed; opacity: 0.5; }
        .log-entry { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        details > summary {
            cursor: pointer;
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        #ayuda-container[open] {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800">M√≥dulo de Alerta</h1>
            <p class="text-gray-500 text-sm mt-1">Prueba de notificaciones</p>
        </div>

        <!-- Caja de Diagn√≥stico -->
        <div id="diagnostic-box" class="mb-6">
            <!-- El JS pondr√° aqu√≠ el estado del permiso -->
        </div>

        <!-- Bot√≥n Principal -->
        <div class="mb-6">
            <button id="vibrate-button" class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg text-lg btn-disabled" disabled>
                Enviar Alerta
            </button>
        </div>
        
        <!-- === ESTE ES EL CAMBIO === -->
        <!-- Men√∫ de Ayuda Desplegable (Texto Gen√©rico) -->
        <div id="ayuda-container" class="hidden">
            <details class="bg-yellow-100 rounded-md border border-yellow-300">
                <!-- T√≠tulo gen√©rico -->
                <summary class="p-3 font-semibold text-yellow-900 flex items-center">
                    <span class="text-xl mr-2">üîî</span>
                    <span class="flex-1">
                        <b>Ayuda:</b> ¬øLa notificaci√≥n es silenciosa?
                    </span>
                    <span class="text-xs font-normal ml-2">(Presiona)</span>
                </summary>
                
                <!-- Contenido gen√©rico -->
                <div class="p-3 border-t border-yellow-300 text-xs text-gray-700 space-y-2">
                    <p>Para asegurar que las alertas de esta app vibren o suenen, debes revisar los permisos del sitio.</p>
                    <p class="font-semibold">Ruta r√°pida (en Chrome):</p>
                    <ol class="list-decimal list-inside space-y-1">
                        <li>Toca el candado (üîí) en la barra de direcciones.</li>
                        <li>Toca <b class="text-black">"Permisos"</b> (o "Configuraci√≥n de sitios").</li>
                        <li>Toca <b class="text-black">"Notificaciones"</b>.</li>
                        <li>Activa el interruptor de <b class="text-black">"Vibraci√≥n"</b> y "Sonido".</li>
                    </ol>
                </div>
            </details>
        </div>
        <!-- === FIN DEL CAMBIO === -->

        <!-- Registro de Eventos -->
        <div class="mt-4">
            <h3 class="text-sm font-semibold text-gray-600 mb-2 border-b pb-1">Registro de Eventos:</h3>
            <div id="event-log" class="text-xs text-gray-500 space-y-1 h-24 overflow-y-auto bg-gray-50 p-2 rounded-md border">
                <p>Iniciando...</p>
            </div>
        </div>
    </div>

    <script>
        const vibrateButton = document.getElementById('vibrate-button');
        const diagnosticBox = document.getElementById('diagnostic-box');
        const eventLog = document.getElementById('event-log');
        const ayudaContainer = document.getElementById('ayuda-container');
        let serviceWorker;

        function log(message) {
            const time = new Date().toLocaleTimeString();
            const newEntry = document.createElement('p');
            newEntry.className = 'log-entry';
            newEntry.innerHTML = `<span class="font-mono text-gray-400">${time}:</span> ${message}`;
            eventLog.prepend(newEntry);
        }

        async function registerServiceWorker() {
            log('Iniciando registro de Service Worker (SW)...');
            if ('serviceWorker' in navigator) {
                try {
                    // Forzamos la actualizaci√≥n del SW en cada carga para desarrollo
                    const registration = await navigator.serviceWorker.register('sw.js', { updateViaCache: 'none' });
                    serviceWorker = registration.active || registration.waiting || registration.installing;
                    log('Service Worker registrado.');
                    
                    // Esperamos a que el SW est√© activo
                    await navigator.serviceWorker.ready;
                    log('Service Worker listo y controlando.');
                    checkNotificationPermission();

                } catch (error) {
                    log(`Error en registro de SW: ${error.message}`);
                    diagnosticBox.innerHTML = `<div class="bg-red-100 text-red-700 p-3 rounded"><p><b>Error Cr√≠tico:</b> No se pudo registrar el SW.</p></div>`;
                }
            } else {
                diagnosticBox.innerHTML = `<div class="bg-red-100 text-red-700 p-3 rounded"><p><b>Error:</b> Service Workers no soportados en este navegador.</p></div>`;
            }
        }

        function checkNotificationPermission() {
            if ('Notification' in window) {
                const permission = Notification.permission;
                if (permission === 'granted') {
                    diagnosticBox.innerHTML = `<div class="bg-green-100 text-green-800 p-3 rounded"><p><b>Estado:</b> ‚úÖ Permiso concedido. ¬°Listo!</p></div>`;
                    vibrateButton.disabled = false;
                    vibrateButton.classList.remove('btn-disabled');
                    ayudaContainer.classList.remove('hidden'); 
                    log('Permiso de notificaci√≥n ya concedido.');
                } else if (permission === 'denied') {
                    diagnosticBox.innerHTML = `<div class="bg-red-100 text-red-700 p-3 rounded"><p><b>Estado:</b> ‚ùå Permiso denegado. Revisa los ajustes del sitio.</p></div>`;
                    log('Permiso de notificaci√≥n denegado.');
                } else {
                    diagnosticBox.innerHTML = `<div class="bg-yellow-100 text-yellow-800 p-3 rounded"><p><b>Estado:</b> ‚è≥ Solicitando permiso...</p></div>`;
                    log('Solicitando permiso de notificaci√≥n...');
                    Notification.requestPermission().then(checkNotificationPermission);
                }
            }
        }

        vibrateButton.addEventListener('click', () => {
            if (navigator.serviceWorker.controller) {
                log('Enviando solicitud de notificaci√≥n al SW...');
                navigator.serviceWorker.controller.postMessage({
                    type: 'show_alert_notification'
                });
            } else {
                log('Error: El Service Worker no est√° controlando la p√°gina.');
                // Intenta recargar la p√°gina si el SW no est√° activo
                log('Intentando recargar para activar el SW...');
                location.reload();
            }
        });

        navigator.serviceWorker.onmessage = (event) => {
            const data = event.data;
            if (data.type === 'notification_reply') {
                if (data.success) {
                    log('Respuesta del SW: Notificaci√≥n enviada con √©xito!');
                } else {
                    log(`Respuesta del SW: ¬°ERROR! ${data.error}`);
                }
            }
        };

        registerServiceWorker();
    </script>
</body>
</html>


